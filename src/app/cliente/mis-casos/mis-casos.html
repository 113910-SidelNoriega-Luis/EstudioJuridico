<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" routerLink="/panel-cliente">‚öñÔ∏è Estudio Jur√≠dico</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link" routerLink="/panel-cliente/dashboard" routerLinkActive="active">Dashboard</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" routerLink="/panel-cliente/turnos" routerLinkActive="active">Mis Turnos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" routerLink="/panel-cliente/consultas" routerLinkActive="active">Consultas</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" routerLink="/panel-cliente/casos" routerLinkActive="active">Mis Casos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" routerLink="/panel-cliente/documentos" routerLinkActive="active">Documentos</a>
        </li>
      </ul>
      
      <div class="user-menu">
        <span class="text-white">üë§ {{ usuario?.nombre || 'Usuario' }}</span>
      </div>
    </div>
  </div>
</nav>

<!-- Hero Section -->
<section class="hero">
  <div class="hero-content">
    <div class="hero-icon">üìÅ</div>
    <h1>{{ vistaActual === 'lista' ? 'Mis Casos' : casoSeleccionado?.titulo }}</h1>
    <p *ngIf="vistaActual === 'lista'">Seguimiento detallado de tus casos legales</p>
    <p *ngIf="vistaActual === 'detalle'">Caso #{{ casoSeleccionado?.numero }}</p>
  </div>
</section>

<main class="main-content">
  <!-- Vista Lista -->
  <ng-container *ngIf="vistaActual === 'lista'">
    <!-- Estad√≠sticas -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number blue">{{ estadisticas.total }}</div>
        <div class="stat-label">Total Casos</div>
      </div>
      <div class="stat-card">
        <div class="stat-number green">{{ estadisticas.enProceso }}</div>
        <div class="stat-label">En Proceso</div>
      </div>
      <div class="stat-card">
        <div class="stat-number gray">{{ estadisticas.completados }}</div>
        <div class="stat-label">Completados</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-container">
      <div class="tabs">
        <button class="tab-btn" [class.active]="tabListaActivo === 'activos'" (click)="cambiarTabLista('activos')">Casos Activos</button>
        <button class="tab-btn" [class.active]="tabListaActivo === 'completados'" (click)="cambiarTabLista('completados')">Casos Completados</button>
      </div>
    </div>

    <!-- Lista de Casos Activos -->
    <div class="casos-list" *ngIf="tabListaActivo === 'activos'">
      <div class="caso-card" *ngFor="let caso of getCasosActivos()">
        <div class="caso-header">
          <div class="caso-info">
            <span class="caso-numero">Caso #{{ caso.numero }}</span>
            <h3 class="caso-titulo">{{ caso.titulo }}</h3>
            <span class="tipo-badge" [style.backgroundColor]="caso.tipoBadgeColor">{{ caso.tipo }}</span>
          </div>
          <span class="estado-badge" [ngClass]="getEstadoClase(caso.estado)">{{ getEstadoTexto(caso.estado) }}</span>
        </div>
        
        <div class="caso-progreso">
          <span class="progreso-label">Progreso del caso: {{ caso.progreso }}%</span>
          <div class="progreso-bar"><div class="progreso-fill" [style.width.%]="caso.progreso"></div></div>
        </div>

        <div class="caso-meta">
          <div class="meta-item"><span class="meta-label">ASESOR ASIGNADO</span><span class="meta-value">{{ caso.asesor?.nombre || 'Por asignar' }}</span></div>
          <div class="meta-item"><span class="meta-label">FECHA DE INICIO</span><span class="meta-value">{{ caso.fechaInicio }}</span></div>
          <div class="meta-item"><span class="meta-label">√öLTIMA ACTUALIZACI√ìN</span><span class="meta-value">{{ caso.ultimaActualizacion }}</span></div>
          <div class="meta-item"><span class="meta-label">DOCUMENTOS</span><span class="meta-value">{{ caso.documentos.length }} archivos</span></div>
        </div>

        <div class="pagos-alert" *ngIf="tienePagosHabilitados(caso)">
          <span class="alert-icon">üí≥</span>
          <span class="alert-text">Tienes {{ contarPagosHabilitados(caso) }} pago(s) habilitado(s)</span>
          <span class="alert-arrow">‚Üí</span>
        </div>

        <div class="caso-footer">
          <button type="button" class="btn-ver-detalle" (click)="verDetalleCaso(caso)">Ver detalle del caso ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- Lista de Casos Completados -->
    <div class="casos-list" *ngIf="tabListaActivo === 'completados'">
      <div class="caso-card completado" *ngFor="let caso of getCasosCompletados()">
        <div class="caso-header">
          <div class="caso-info">
            <span class="caso-numero">Caso #{{ caso.numero }}</span>
            <h3 class="caso-titulo">{{ caso.titulo }}</h3>
            <span class="tipo-badge" [style.backgroundColor]="caso.tipoBadgeColor">{{ caso.tipo }}</span>
          </div>
          <span class="estado-badge estado-completado">‚úì Completado</span>
        </div>
        <div class="caso-meta">
          <div class="meta-item"><span class="meta-label">ASESOR</span><span class="meta-value">{{ caso.asesor?.nombre }}</span></div>
          <div class="meta-item"><span class="meta-label">FECHA DE INICIO</span><span class="meta-value">{{ caso.fechaInicio }}</span></div>
          <div class="meta-item"><span class="meta-label">FECHA CIERRE</span><span class="meta-value">{{ caso.ultimaActualizacion }}</span></div>
          <div class="meta-item"><span class="meta-label">DOCUMENTOS</span><span class="meta-value">{{ caso.documentos.length }} archivos</span></div>
        </div>
        <div class="caso-footer">
          <button type="button" class="btn-ver-detalle" (click)="verDetalleCaso(caso)">Ver historial del caso ‚Üí</button>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- Vista Detalle -->
  <ng-container *ngIf="vistaActual === 'detalle' && casoSeleccionado">
    <button class="btn-volver" (click)="volverALista()">‚Üê Volver a Mis Casos</button>

    <!-- Info Header -->
    <div class="detalle-header">
      <div class="detalle-info">
        <div class="info-principal">
          <span class="tipo-badge grande" [style.backgroundColor]="casoSeleccionado.tipoBadgeColor">{{ casoSeleccionado.tipo }}</span>
          <span class="estado-badge" [ngClass]="getEstadoClase(casoSeleccionado.estado)">{{ getEstadoTexto(casoSeleccionado.estado) }}</span>
        </div>
        <p class="detalle-descripcion">{{ casoSeleccionado.descripcion }}</p>
        <div class="progreso-grande">
          <div class="progreso-header"><span>Progreso del caso</span><span class="progreso-porcentaje">{{ casoSeleccionado.progreso }}%</span></div>
          <div class="progreso-bar grande"><div class="progreso-fill" [style.width.%]="casoSeleccionado.progreso"></div></div>
        </div>
      </div>

      <div class="asesor-card" *ngIf="casoSeleccionado.asesor">
        <h4>Asesor Asignado</h4>
        <div class="asesor-info">
          <div class="asesor-avatar">{{ getIniciales(casoSeleccionado.asesor.nombre) }}</div>
          <div class="asesor-datos"><span class="asesor-nombre">{{ casoSeleccionado.asesor.nombre }}</span><span class="asesor-email">{{ casoSeleccionado.asesor.email }}</span></div>
        </div>
        <div class="asesor-acciones">
          <button class="btn-asesor" (click)="contactarAsesor()">‚úâÔ∏è Email</button>
          <button class="btn-asesor" (click)="llamarAsesor()">üìû Llamar</button>
        </div>
      </div>
      <div class="asesor-card pendiente" *ngIf="!casoSeleccionado.asesor">
        <h4>‚è≥ Pendiente de Asignaci√≥n</h4>
        <p>Tu caso est√° siendo revisado para asignar el asesor m√°s adecuado.</p>
      </div>
    </div>

    <!-- Pr√≥xima Audiencia -->
    <div class="audiencia-card" *ngIf="casoSeleccionado.proximaAudiencia">
      <div class="audiencia-icon">üèõÔ∏è</div>
      <div class="audiencia-info">
        <h4>Pr√≥xima Audiencia</h4>
        <p class="audiencia-tipo">{{ casoSeleccionado.proximaAudiencia.tipo }}</p>
        <div class="audiencia-detalles">
          <span>üìÖ {{ casoSeleccionado.proximaAudiencia.fecha }} - {{ casoSeleccionado.proximaAudiencia.hora }} hs</span>
          <span>üìç {{ casoSeleccionado.proximaAudiencia.lugar }}</span>
        </div>
      </div>
    </div>

    <!-- Alerta Pagos Habilitados -->
    <div class="pagos-habilitados-alert" *ngIf="getPagosHabilitados().length > 0">
      <div class="alert-content">
        <span class="alert-icon-grande">üí≥</span>
        <div class="alert-texto">
          <h4>Tienes {{ getPagosHabilitados().length }} pago(s) habilitado(s)</h4>
          <p>Tu asesor ha habilitado pagos pendientes que puedes realizar ahora con Mercado Pago.</p>
        </div>
      </div>
      <button class="btn-ver-pagos" (click)="cambiarTabDetalle('pagos')">Ver Pagos ‚Üí</button>
    </div>

    <!-- Tabs Detalle -->
    <div class="detalle-tabs">
      <button class="tab-btn" [class.active]="tabDetalleActivo === 'resumen'" (click)="cambiarTabDetalle('resumen')">üìã Resumen</button>
      <button class="tab-btn" [class.active]="tabDetalleActivo === 'documentos'" (click)="cambiarTabDetalle('documentos')">üìÅ Documentos ({{ casoSeleccionado.documentos.length }})</button>
      <button class="tab-btn" [class.active]="tabDetalleActivo === 'movimientos'" (click)="cambiarTabDetalle('movimientos')">üìú Movimientos ({{ casoSeleccionado.movimientos.length }})</button>
      <button class="tab-btn" [class.active]="tabDetalleActivo === 'pagos'" (click)="cambiarTabDetalle('pagos')">üí∞ Pagos<span class="badge-pagos" *ngIf="getPagosHabilitados().length > 0">{{ getPagosHabilitados().length }}</span></button>
    </div>

    <!-- Tab Resumen -->
    <div class="tab-content" *ngIf="tabDetalleActivo === 'resumen'">
      <div class="resumen-grid">
        <div class="resumen-card">
          <h4>üìÖ Fechas Importantes</h4>
          <div class="info-list">
            <div class="info-row"><span class="info-label">Fecha de Inicio:</span><span class="info-value">{{ casoSeleccionado.fechaInicio }}</span></div>
            <div class="info-row"><span class="info-label">√öltima Actualizaci√≥n:</span><span class="info-value">{{ casoSeleccionado.ultimaActualizacion }}</span></div>
            <div class="info-row" *ngIf="casoSeleccionado.proximaAudiencia"><span class="info-label">Pr√≥xima Audiencia:</span><span class="info-value">{{ casoSeleccionado.proximaAudiencia.fecha }}</span></div>
          </div>
        </div>
        <div class="resumen-card">
          <h4>üìä Estado Financiero</h4>
          <div class="financiero-stats">
            <div class="fin-stat"><span class="fin-label">Total Pagado</span><span class="fin-value verde">{{ formatearMonto(getTotalPagado()) }}</span></div>
            <div class="fin-stat"><span class="fin-label">Total Pendiente</span><span class="fin-value naranja">{{ formatearMonto(getTotalPendiente()) }}</span></div>
          </div>
        </div>
        <div class="resumen-card full-width" *ngIf="casoSeleccionado.notas">
          <h4>üìù Notas del Asesor</h4>
          <p class="notas-texto">{{ casoSeleccionado.notas }}</p>
        </div>
        <div class="resumen-card">
          <h4>üìÅ Documentos Recientes</h4>
          <div class="docs-preview">
            <div class="doc-mini" *ngFor="let doc of casoSeleccionado.documentos.slice(0, 3)"><span class="doc-icon">{{ getIconoDocumento(doc.tipo) }}</span><span class="doc-nombre">{{ doc.nombre }}</span></div>
            <button class="btn-ver-todos" (click)="cambiarTabDetalle('documentos')" *ngIf="casoSeleccionado.documentos.length > 3">Ver todos ({{ casoSeleccionado.documentos.length }})</button>
          </div>
        </div>
        <div class="resumen-card">
          <h4>üìú √öltimos Movimientos</h4>
          <div class="movs-preview">
            <div class="mov-mini" *ngFor="let mov of casoSeleccionado.movimientos.slice(0, 3)"><span class="mov-icon">{{ mov.icono }}</span><div class="mov-info"><span class="mov-titulo">{{ mov.titulo }}</span><span class="mov-fecha">{{ mov.fecha }}</span></div></div>
            <button class="btn-ver-todos" (click)="cambiarTabDetalle('movimientos')" *ngIf="casoSeleccionado.movimientos.length > 3">Ver todos ({{ casoSeleccionado.movimientos.length }})</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Documentos -->
    <div class="tab-content" *ngIf="tabDetalleActivo === 'documentos'">
      <div class="documentos-header"><h3>Documentos del Caso</h3><button class="btn-subir" (click)="irADocumentos()">+ Subir Documento</button></div>
      <div class="documentos-grid">
        <div class="documento-card" *ngFor="let doc of casoSeleccionado.documentos">
          <div class="doc-icono">{{ getIconoDocumento(doc.tipo) }}</div>
          <div class="doc-info">
            <h4>{{ doc.nombre }}</h4>
            <p class="doc-descripcion" *ngIf="doc.descripcion">{{ doc.descripcion }}</p>
            <div class="doc-meta"><span>{{ doc.extension }}</span><span>{{ doc.tamanio }}</span><span>{{ doc.fecha }}</span></div>
          </div>
          <div class="doc-acciones">
            <button class="btn-doc" (click)="verDocumento(doc); $event.stopPropagation()">üëÅÔ∏è Ver</button>
            <button class="btn-doc" (click)="descargarDocumento(doc); $event.stopPropagation()">‚¨áÔ∏è Descargar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Movimientos -->
    <div class="tab-content" *ngIf="tabDetalleActivo === 'movimientos'">
      <h3>Historial de Movimientos</h3>
      <div class="timeline">
        <div class="timeline-item" *ngFor="let mov of casoSeleccionado.movimientos" [ngClass]="getClaseMovimiento(mov.tipo)">
          <div class="timeline-marker"><span class="marker-icon">{{ mov.icono }}</span></div>
          <div class="timeline-content">
            <div class="timeline-header"><h4>{{ mov.titulo }}</h4><span class="timeline-fecha">{{ mov.fecha }}</span></div>
            <p>{{ mov.descripcion }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Pagos -->
    <div class="tab-content" *ngIf="tabDetalleActivo === 'pagos'">
      <div class="pagos-resumen">
        <div class="pago-stat"><span class="pago-stat-label">Total Pagado</span><span class="pago-stat-value verde">{{ formatearMonto(getTotalPagado()) }}</span></div>
        <div class="pago-stat"><span class="pago-stat-label">Total Pendiente</span><span class="pago-stat-value naranja">{{ formatearMonto(getTotalPendiente()) }}</span></div>
      </div>

      <!-- Pagos Habilitados -->
      <div class="pagos-seccion" *ngIf="getPagosHabilitados().length > 0">
        <h3 class="seccion-titulo habilitado">üí≥ Pagos Habilitados para Pagar</h3>
        <div class="pagos-list">
          <div class="pago-card habilitado" *ngFor="let pago of getPagosHabilitados()">
            <div class="pago-info"><h4>{{ pago.concepto }}</h4><p class="pago-vencimiento">Vence: {{ pago.fechaVencimiento }}</p></div>
            <div class="pago-monto">
              <span class="monto">{{ formatearMonto(pago.monto) }}</span>
              <button class="btn-pagar-mp" (click)="abrirModalPago(pago)">
                <img src="https://http2.mlstatic.com/frontend-assets/mp-web-navigation/ui-navigation/6.6.92/mercadopago/logo__small@2x.png" alt="MP" class="mp-logo">
                Pagar con Mercado Pago
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Pagos Pendientes -->
      <div class="pagos-seccion" *ngIf="getPagosPendientes().length > 0">
        <h3 class="seccion-titulo pendiente">‚è≥ Pendientes de Habilitar</h3>
        <p class="seccion-desc">Estos pagos ser√°n habilitados por tu asesor cuando corresponda.</p>
        <div class="pagos-list">
          <div class="pago-card pendiente" *ngFor="let pago of getPagosPendientes()">
            <div class="pago-info"><h4>{{ pago.concepto }}</h4><p class="pago-vencimiento" *ngIf="pago.fechaVencimiento">Fecha estimada: {{ pago.fechaVencimiento }}</p></div>
            <div class="pago-monto"><span class="monto">{{ formatearMonto(pago.monto) }}</span><span class="estado-pago pendiente">Pendiente</span></div>
          </div>
        </div>
      </div>

      <!-- Pagos Realizados -->
      <div class="pagos-seccion" *ngIf="getPagosPagados().length > 0">
        <h3 class="seccion-titulo pagado">‚úÖ Pagos Realizados</h3>
        <div class="pagos-list">
          <div class="pago-card pagado" *ngFor="let pago of getPagosPagados()">
            <div class="pago-info"><h4>{{ pago.concepto }}</h4><p class="pago-fecha">Pagado: {{ pago.fechaPago }} - {{ pago.metodoPago }}</p></div>
            <div class="pago-monto"><span class="monto">{{ formatearMonto(pago.monto) }}</span><span class="estado-pago pagado">‚úì Pagado</span></div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</main>

<!-- Modal Pago Mercado Pago -->
<div class="modal-overlay" *ngIf="mostrarModalPago" (click)="cerrarModalPago()">
  <div class="modal-pago" (click)="$event.stopPropagation()">
    <button class="modal-cerrar" (click)="cerrarModalPago()">√ó</button>
    <div class="modal-header-mp">
      <img src="https://http2.mlstatic.com/frontend-assets/mp-web-navigation/ui-navigation/6.6.92/mercadopago/logo__large@2x.png" alt="Mercado Pago" class="mp-logo-grande">
    </div>
    <div class="modal-body-mp" *ngIf="pagoSeleccionado">
      <h3>Confirmar Pago</h3>
      <div class="pago-detalle">
        <div class="detalle-row"><span class="detalle-label">Concepto:</span><span class="detalle-valor">{{ pagoSeleccionado.concepto }}</span></div>
        <div class="detalle-row"><span class="detalle-label">Caso:</span><span class="detalle-valor">#{{ casoSeleccionado?.numero }} - {{ casoSeleccionado?.titulo }}</span></div>
        <div class="detalle-row"><span class="detalle-label">Vencimiento:</span><span class="detalle-valor">{{ pagoSeleccionado.fechaVencimiento }}</span></div>
      </div>
      <div class="monto-total"><span class="monto-label">Total a Pagar</span><span class="monto-valor">{{ formatearMonto(pagoSeleccionado.monto) }}</span></div>
      <div class="metodos-pago">
        <p>Pod√©s pagar con:</p>
        <div class="metodos-iconos">
          <span class="metodo">üí≥ Tarjeta de cr√©dito/d√©bito</span>
          <span class="metodo">üè¶ Transferencia bancaria</span>
          <span class="metodo">üíµ Efectivo en puntos de pago</span>
          <span class="metodo">üì± Dinero en cuenta MP</span>
        </div>
      </div>
      <button class="btn-confirmar-mp" (click)="pagarConMercadoPago()" [disabled]="procesandoPago">
        <span *ngIf="!procesandoPago">Ir a Mercado Pago ‚Üí</span>
        <span *ngIf="procesandoPago">Redirigiendo...</span>
      </button>
      <p class="seguridad-texto">üîí Pago 100% seguro procesado por Mercado Pago</p>
    </div>
  </div>
</div>

<!-- Modal Documento -->
<div class="modal-overlay" *ngIf="mostrarModalDocumento" (click)="cerrarModalDocumento()">
  <div class="modal-documento" (click)="$event.stopPropagation()">
    <button class="modal-cerrar" (click)="cerrarModalDocumento()">√ó</button>
    <div class="modal-doc-header">
      <span class="doc-icono-grande">{{ documentoSeleccionado ? getIconoDocumento(documentoSeleccionado.tipo) : '' }}</span>
      <h3>{{ documentoSeleccionado?.nombre }}</h3>
    </div>
    <div class="modal-doc-body" *ngIf="documentoSeleccionado">
      <div class="doc-preview">
        <div class="preview-placeholder">
          <span class="preview-icon">{{ getIconoDocumento(documentoSeleccionado.tipo) }}</span>
          <p>Vista previa del documento</p>
          <span class="preview-meta">{{ documentoSeleccionado.extension }} | {{ documentoSeleccionado.tamanio }}</span>
        </div>
      </div>
      <div class="doc-info-completa">
        <div class="info-row" *ngIf="documentoSeleccionado.descripcion"><span class="info-label">Descripci√≥n:</span><span class="info-value">{{ documentoSeleccionado.descripcion }}</span></div>
        <div class="info-row"><span class="info-label">Fecha:</span><span class="info-value">{{ documentoSeleccionado.fecha }}</span></div>
        <div class="info-row"><span class="info-label">Tama√±o:</span><span class="info-value">{{ documentoSeleccionado.tamanio }}</span></div>
      </div>
      <div class="modal-doc-acciones"><button class="btn-descargar" (click)="descargarDocumento(documentoSeleccionado)">‚¨áÔ∏è Descargar Documento</button></div>
    </div>
  </div>
</div>
