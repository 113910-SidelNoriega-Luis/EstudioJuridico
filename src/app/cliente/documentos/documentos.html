<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" routerLink="/panel-cliente">‚öñÔ∏è Estudio Jur√≠dico</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link" routerLink="/panel-cliente/dashboard" routerLinkActive="active">Dashboard</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" routerLink="/panel-cliente/turnos" routerLinkActive="active">Mis Turnos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" routerLink="/panel-cliente/consultas" routerLinkActive="active">Consultas</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" routerLink="/panel-cliente/casos" routerLinkActive="active">Mis Casos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" routerLink="/panel-cliente/documentos" routerLinkActive="active">Documentos</a>
        </li>
      </ul>
      
      <div class="user-menu">
        <span class="text-white">üë§ {{ usuario?.nombre || 'Usuario' }}</span>
      </div>
    </div>
  </div>
</nav>

<!-- Hero Section -->
<section class="panel-hero">
  <div class="container">
    <h1>üìÑ Mis Documentos</h1>
    <p>Gestiona tus documentos, crea escritos y usa plantillas predeterminadas</p>
  </div>
</section>

<!-- Contenido Principal -->
<div class="container">

  <!-- Estad√≠sticas -->
  <div class="stat-inline">
    <div class="stat-item">
      <div class="stat-item-value">{{ estadisticas.totalDocumentos }}</div>
      <div class="stat-item-label">Total Documentos</div>
    </div>
    <div class="stat-item">
      <div class="stat-item-value" style="color: #6f42c1;">{{ estadisticas.plantillasUsadas }}</div>
      <div class="stat-item-label">Escritos Creados</div>
    </div>
    <div class="stat-item">
      <div class="stat-item-value" style="color: #198754;">{{ estadisticas.documentosSubidos }}</div>
      <div class="stat-item-label">Archivos Subidos</div>
    </div>
  </div>

  <!-- Acciones R√°pidas -->
  <div class="quick-actions-docs">
    <div class="quick-action-btn" (click)="cambiarTab('subir')">
      <div class="quick-action-icon">üì§</div>
      <div class="quick-action-label">Subir Archivo</div>
    </div>
    <div class="quick-action-btn" (click)="cambiarTab('nuevo')">
      <div class="quick-action-icon">üìù</div>
      <div class="quick-action-label">Nuevo Escrito</div>
    </div>
    <div class="quick-action-btn" (click)="cambiarTab('plantillas')">
      <div class="quick-action-icon">üìã</div>
      <div class="quick-action-label">Plantillas</div>
    </div>
    <div class="quick-action-btn" (click)="cambiarTab('documentos')">
      <div class="quick-action-icon">üìÇ</div>
      <div class="quick-action-label">Ver Todos</div>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <button class="nav-link" 
              [class.active]="tabActivo === 'documentos'" 
              (click)="cambiarTab('documentos')">
        Mis Documentos
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" 
              [class.active]="tabActivo === 'subir'" 
              (click)="cambiarTab('subir')">
        Subir Archivo
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" 
              [class.active]="tabActivo === 'nuevo'" 
              (click)="cambiarTab('nuevo')">
        Nuevo Escrito
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" 
              [class.active]="tabActivo === 'plantillas'" 
              (click)="cambiarTab('plantillas')">
        Plantillas
      </button>
    </li>
  </ul>

  <!-- TAB: MIS DOCUMENTOS -->
  <div *ngIf="tabActivo === 'documentos'">
    
    <!-- Filtros -->
    <div class="filtros-section">
      <div class="row align-items-center">
        <div class="col-md-4 mb-3 mb-md-0">
          <input type="text" 
                 class="form-control" 
                 placeholder="üîç Buscar documento..."
                 [(ngModel)]="filtros.busqueda"
                 (input)="filtrarDocumentos()">
        </div>
        <div class="col-md-3 mb-3 mb-md-0">
          <select class="form-select" 
                  [(ngModel)]="filtros.tipo"
                  (change)="filtrarDocumentos()">
            <option value="todos">Todos los tipos</option>
            <option value="pdf">PDF</option>
            <option value="doc">Documentos Word</option>
            <option value="img">Im√°genes</option>
            <option value="escrito">Escritos</option>
          </select>
        </div>
        <div class="col-md-3 mb-3 mb-md-0">
          <select class="form-select"
                  [(ngModel)]="filtros.caso"
                  (change)="filtrarDocumentos()">
            <option value="todos">Todos los casos</option>
            <option *ngFor="let caso of casosDisponibles" [value]="caso.id">
              {{ caso.numero }} - {{ caso.titulo }}
            </option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-outline-primary w-100" (click)="limpiarFiltros()">
            Limpiar
          </button>
        </div>
      </div>
    </div>

    <!-- Lista de Documentos -->
    <div class="content-card">
      <h5>üìÇ Documentos ({{ documentosFiltrados.length }})</h5>
      
      <div *ngIf="documentosFiltrados.length === 0" class="alert alert-info">
        No se encontraron documentos. ¬°Sube tu primer archivo o crea un escrito!
      </div>

      <div *ngFor="let doc of documentosFiltrados" 
           class="documento-list-item"
           [class.pdf]="doc.tipo === 'pdf'"
           [class.doc]="doc.tipo === 'doc'"
           [class.img]="doc.tipo === 'img'">
        <div class="documento-icon" [ngClass]="doc.tipo">
          {{ getIconoTipo(doc.tipo) }}
        </div>
        <div class="documento-info flex-grow-1">
          <div class="documento-nombre">{{ doc.nombre }}</div>
          <div class="documento-meta">
            <span class="badge bg-secondary me-2">{{ doc.extension }}</span>
            <span *ngIf="doc.caso" class="badge bg-primary me-2">Caso #{{ doc.caso }}</span>
            {{ doc.tamanio }} ‚Ä¢ {{ doc.fecha }}
          </div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-primary" (click)="previsualizarDocumento(doc)">
            üëÅÔ∏è Ver
          </button>
          <button class="btn btn-sm btn-outline-success" (click)="descargarDocumento(doc)">
            ‚¨áÔ∏è Descargar
          </button>
          <button class="btn btn-sm btn-outline-danger" (click)="eliminarDocumento(doc)">
            üóëÔ∏è
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB: SUBIR ARCHIVO -->
  <div *ngIf="tabActivo === 'subir'">
    <div class="content-card">
      <h5>üì§ Subir Archivo</h5>
      
      <!-- Zona de Upload -->
      <div class="upload-zone"
           [class.dragover]="isDragging"
           (dragover)="onDragOver($event)"
           (dragleave)="onDragLeave($event)"
           (drop)="onDrop($event)"
           (click)="fileInput.click()">
        <div class="upload-zone-icon">üìÅ</div>
        <h5>Arrastra tus archivos aqu√≠</h5>
        <p>o haz clic para seleccionar</p>
        <button class="btn btn-primary">Seleccionar Archivos</button>
        <p class="mt-3 text-muted small">
          Formatos aceptados: PDF, DOC, DOCX, JPG, PNG ‚Ä¢ M√°ximo 10MB por archivo
        </p>
        <input type="file" 
               #fileInput 
               (change)="onFileSelected($event)"
               multiple
               accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
               style="display: none;">
      </div>

      <!-- Archivos seleccionados -->
      <div *ngIf="archivosSeleccionados.length > 0" class="mt-4">
        <h6>Archivos seleccionados:</h6>
        <div *ngFor="let archivo of archivosSeleccionados; let i = index" 
             class="documento-list-item">
          <div class="documento-icon" [ngClass]="getTipoArchivo(archivo.name)">
            {{ getIconoTipo(getTipoArchivo(archivo.name)) }}
          </div>
          <div class="documento-info flex-grow-1">
            <div class="documento-nombre">{{ archivo.name }}</div>
            <div class="documento-meta">{{ formatearTamanio(archivo.size) }}</div>
          </div>
          <button class="btn btn-sm btn-outline-danger" (click)="removerArchivo(i)">
            ‚úï
          </button>
        </div>

        <!-- Asociar a caso -->
        <div class="row mt-3">
          <div class="col-md-6">
            <label class="form-label">Asociar a caso (opcional)</label>
            <select class="form-select" [(ngModel)]="casoSeleccionado">
              <option value="">Sin asociar</option>
              <option *ngFor="let caso of casosDisponibles" [value]="caso.id">
                {{ caso.numero }} - {{ caso.titulo }}
              </option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Descripci√≥n (opcional)</label>
            <input type="text" 
                   class="form-control" 
                   [(ngModel)]="descripcionArchivo"
                   placeholder="Ej: Contrato de trabajo firmado">
          </div>
        </div>

        <button class="btn btn-primary mt-3" (click)="subirArchivos()">
          üì§ Subir {{ archivosSeleccionados.length }} archivo(s)
        </button>
      </div>
    </div>
  </div>

  <!-- TAB: NUEVO ESCRITO -->
  <div *ngIf="tabActivo === 'nuevo'">
    <div class="content-card">
      <div class="escrito-header">
        <h5>üìù Nuevo Escrito Electr√≥nico</h5>
      </div>

      <div class="info-banner">
        <p>
          <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Seleccione el tipo de escrito de la lista. 
          El sistema le propone una plantilla gen√©rica. Redacte libremente el contenido de su escrito.
        </p>
      </div>

      <!-- Tipo de Escrito y Plantilla -->
      <div class="row mb-4">
        <div class="col-md-6">
          <label class="form-label fw-bold">Tipo de Escrito</label>
          <select class="form-select" 
                  [(ngModel)]="nuevoEscrito.tipo"
                  (change)="onTipoEscritoChange()">
            <option value="">Seleccione...</option>
            <option *ngFor="let tipo of tiposEscrito" [value]="tipo.value">
              {{ tipo.label }}
            </option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-bold">Texto Modelo</label>
          <select class="form-select" 
                  [(ngModel)]="nuevoEscrito.plantilla"
                  (change)="cargarPlantilla()">
            <option value="generica">Plantilla Gen√©rica</option>
            <option *ngFor="let plantilla of plantillasDisponibles" [value]="plantilla.id">
              {{ plantilla.nombre }}
            </option>
          </select>
        </div>
      </div>

      <!-- Caso asociado -->
      <div class="row mb-4">
        <div class="col-md-6">
          <label class="form-label fw-bold">Asociar a Caso</label>
          <select class="form-select" [(ngModel)]="nuevoEscrito.caso">
            <option value="">Sin asociar</option>
            <option *ngFor="let caso of casosDisponibles" [value]="caso.id">
              {{ caso.numero }} - {{ caso.titulo }}
            </option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-bold">Car√°tula</label>
          <input type="text" 
                 class="form-control" 
                 [(ngModel)]="nuevoEscrito.caratula"
                 placeholder="Ej: PEREZ JUAN C/ EMPRESA SA S/ DESPIDO">
        </div>
      </div>

      <!-- Variables disponibles -->
      <div class="mb-3">
        <label class="form-label fw-bold">Variables disponibles (click para insertar):</label>
        <div class="d-flex flex-wrap gap-2">
          <span *ngFor="let variable of variablesDisponibles" 
                class="variable-tag"
                (click)="insertarVariable(variable)">
            {{ variable }}
          </span>
        </div>
      </div>

      <!-- Editor -->
      <label class="form-label fw-bold">Texto del escrito</label>
      <div class="editor-container">
        <div class="editor-toolbar">
          <select (change)="formatText('formatBlock', $event)">
            <option value="">P√°rrafo</option>
            <option value="h1">T√≠tulo 1</option>
            <option value="h2">T√≠tulo 2</option>
            <option value="h3">T√≠tulo 3</option>
          </select>
          <div class="separator"></div>
          <button class="btn-tool" (click)="formatText('bold')" title="Negrita">
            <strong>B</strong>
          </button>
          <button class="btn-tool" (click)="formatText('italic')" title="Cursiva">
            <em>I</em>
          </button>
          <button class="btn-tool" (click)="formatText('underline')" title="Subrayado">
            <u>U</u>
          </button>
          <div class="separator"></div>
          <button class="btn-tool" (click)="formatText('justifyLeft')" title="Alinear izquierda">
            ‚â°
          </button>
          <button class="btn-tool" (click)="formatText('justifyCenter')" title="Centrar">
            ‚â°
          </button>
          <button class="btn-tool" (click)="formatText('justifyRight')" title="Alinear derecha">
            ‚â°
          </button>
          <button class="btn-tool" (click)="formatText('justifyFull')" title="Justificar">
            ‚â°
          </button>
          <div class="separator"></div>
          <button class="btn-tool" (click)="formatText('insertUnorderedList')" title="Lista">
            ‚Ä¢
          </button>
          <button class="btn-tool" (click)="formatText('insertOrderedList')" title="Lista numerada">
            1.
          </button>
          <div class="separator"></div>
          <button class="btn-tool" (click)="limpiarEditor()" title="Limpiar">
            üóëÔ∏è
          </button>
        </div>
        <div class="editor-content" 
             #editorContent
             contenteditable="true"
             (input)="onEditorInput($event)"
             [innerHTML]="nuevoEscrito.contenido">
        </div>
      </div>

      <!-- Botones de acci√≥n -->
      <div class="d-flex justify-content-between mt-4">
        <div>
          <button class="btn btn-outline-secondary me-2" (click)="limpiarEscrito()">
            üóëÔ∏è Limpiar
          </button>
          <button class="btn btn-outline-primary" (click)="previsualizarEscrito()">
            üëÅÔ∏è Previsualizar
          </button>
        </div>
        <div>
          <button class="btn btn-outline-success me-2" (click)="guardarBorrador()">
            üíæ Guardar Borrador
          </button>
          <button class="btn btn-primary" (click)="guardarEscrito()">
            ‚úÖ Guardar Escrito
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB: PLANTILLAS -->
  <div *ngIf="tabActivo === 'plantillas'">
    <div class="content-card">
      <h5>üìã Plantillas Predeterminadas</h5>
      <p class="text-muted">Selecciona una plantilla para crear un nuevo escrito basado en ella</p>

      <div class="row">
        <div class="col-md-4 mb-4" *ngFor="let plantilla of plantillas">
          <div class="plantilla-card" 
               [class.selected]="plantillaSeleccionada?.id === plantilla.id"
               (click)="seleccionarPlantilla(plantilla)">
            <div class="plantilla-icon">{{ plantilla.icono }}</div>
            <div class="plantilla-nombre">{{ plantilla.nombre }}</div>
            <div class="plantilla-descripcion">{{ plantilla.descripcion }}</div>
            <span class="badge mt-2" [ngClass]="'tipo-' + plantilla.tipo">
              {{ plantilla.tipo | uppercase }}
            </span>
          </div>
        </div>
      </div>

      <!-- Vista previa de plantilla seleccionada -->
      <div *ngIf="plantillaSeleccionada" class="mt-4">
        <h6>Vista Previa: {{ plantillaSeleccionada.nombre }}</h6>
        <div class="documento-preview" [innerHTML]="plantillaSeleccionada.contenido">
        </div>
        <div class="mt-3">
          <button class="btn btn-primary" (click)="usarPlantilla(plantillaSeleccionada)">
            ‚úèÔ∏è Usar Esta Plantilla
          </button>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Modal Previsualizaci√≥n -->
<div class="modal fade" 
     [class.show]="mostrarModalPreview" 
     [style.display]="mostrarModalPreview ? 'block' : 'none'"
     tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üëÅÔ∏è Vista Previa del Documento</h5>
        <button type="button" class="btn-close" (click)="cerrarModalPreview()"></button>
      </div>
      <div class="modal-body">
        <div class="documento-preview" style="max-height: 500px;" [innerHTML]="documentoPreview">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalPreview()">Cerrar</button>
        <button type="button" class="btn btn-outline-primary" (click)="imprimirDocumento()">
          üñ®Ô∏è Imprimir
        </button>
        <button type="button" class="btn btn-primary" (click)="descargarDocumentoPreview()">
          ‚¨áÔ∏è Descargar PDF
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop del modal -->
<div class="modal-backdrop fade" 
     [class.show]="mostrarModalPreview"
     *ngIf="mostrarModalPreview"
     (click)="cerrarModalPreview()"></div>

<!-- Footer -->
<footer class="bg-dark text-white py-4 mt-5">
  <div class="container">
    <div class="row">
      <div class="col-md-6">
        <h5>Estudio Jur√≠dico</h5>
        <p class="small">Soluciones legales profesionales desde 2003</p>
      </div>
      <div class="col-md-6 text-md-end">
        <p class="small mb-0">&copy; 2024 Estudio Jur√≠dico. Todos los derechos reservados.</p>
      </div>
    </div>
  </div>
</footer>
