<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" routerLink="/panel-cliente"
      style="cursor: pointer;">‚öñÔ∏è Estudio Jur√≠dico</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
      data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link" routerLink="/panel-cliente/dashboard"
            routerLinkActive="active">Dashboard</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" routerLink="/panel-cliente/turnos"
            routerLinkActive="active">Mis Turnos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" routerLink="/panel-cliente/consultas"
            routerLinkActive="active">Consultas</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" routerLink="/panel-cliente/casos"
            routerLinkActive="active">Mis Casos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" routerLink="/panel-cliente/documentos"
            routerLinkActive="active">Documentos</a>
        </li>
      </ul>

      <div class="user-menu">
        <span class="text-white">üë§ {{ usuario?.nombre || 'Usuario' }}</span>
      </div>
    </div>
  </div>
</nav>

<!-- Hero Section -->
<section class="panel-hero">
  <div class="container">
    <h1>üìÖ Mis Turnos</h1>
    <p>Gestiona y agenda tus turnos para consultas legales</p>
  </div>
</section>

<!-- Contenido Principal -->
<div class="container">

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <button class="nav-link"
        [class.active]="tabActivo === 'agendar'"
        (click)="cambiarTab('agendar')"
        type="button">
        Agendar Turno
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link"
        [class.active]="tabActivo === 'misturnos'"
        (click)="cambiarTab('misturnos')"
        type="button">
        Mis Turnos
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link"
        [class.active]="tabActivo === 'historial'"
        (click)="cambiarTab('historial')"
        type="button">
        Historial
      </button>
    </li>
  </ul>

  <!-- TAB: AGENDAR TURNO -->
  <div *ngIf="tabActivo === 'agendar'">

    <div class="content-card">
      <!-- <h5>Selecciona una fecha</h5> -->

      <!-- Selector de Fechas Avanzado -->
      <!-- <app-selector-fecha
        [fechasDisponibles]="fechasConTurnos"
        (fechaSeleccionadaEvent)="onFechaSeleccionada($event)">
      </app-selector-fecha> -->

      <h5 class="mt-4">Selecciona un horario disponible</h5>

      <div class="alert alert-info mb-4">
        <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Los turnos son de 30 minutos.
        Selecciona un horario
        <span class="badge bg-success">Disponible</span> para agendar tu
        consulta.
      </div>

      <!-- Tabla de Agenda -->
       <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Agenda Semanal</h5>
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-primary"
            (click)="anteriorSemana()"
            [disabled]="semanaOffset === 0">
            ‚Üê Semana Anterior
          </button>
          
          <button class="btn btn-sm btn-outline-primary"
            (click)="siguienteSemana()">
            Semana Siguiente ‚Üí
          </button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="agenda-table">
          <thead>
            <tr>
              <th class="time-column">Horario</th>
              <th *ngFor="let dia of dias">{{ dia.nombre }}</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let hora of horarios">
              <td class="time-column">{{ hora }}</td>
              <td *ngFor="let slot of agendaSlots[hora]"
                [ngClass]="{
                    'slot-disponible': slot.disponible && !isSlotSeleccionado(slot),
                    'slot-ocupado': !slot.disponible,
                    'slot-seleccionado': isSlotSeleccionado(slot)
                  }"
                (click)="seleccionarTurno(slot)"
                [style.cursor]="slot.disponible ? 'pointer' : 'default'">
                <span *ngIf="!slot.disponible">Ocupado</span>
                <span
                  *ngIf="slot.disponible && !isSlotSeleccionado(slot)">Disponible</span>
                <span *ngIf="isSlotSeleccionado(slot)">Seleccionado</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Leyenda -->
      <div class="leyenda">
        <div class="leyenda-item">
          <div class="leyenda-color" style="background-color: #198754;"></div>
          <span>Disponible</span>
        </div>
        <div class="leyenda-item">
          <div class="leyenda-color" style="background-color: #dc3545;"></div>
          <span>Ocupado</span>
        </div>
        <div class="leyenda-item">
          <div class="leyenda-color" style="background-color: #0d6efd;"></div>
          <span>Seleccionado</span>
        </div>
      </div>

      <!-- Turno Seleccionado -->
      <div *ngIf="turnoSeleccionado" class="alert alert-success mt-4">
        <h6 class="mb-3">‚úÖ Turno Seleccionado:</h6>
        <p class="mb-3">
          <strong>Fecha:</strong> {{ turnoSeleccionado.fechaTexto }}<br>
          <strong>Horario:</strong> {{ turnoSeleccionado.hora }} a {{
          turnoSeleccionado.horaFin }} hs
        </p>
        <button class="btn btn-primary" (click)="abrirModalConfirmar()">
          Confirmar Turno
        </button>
      </div>
    </div>

  </div>

  <!-- TAB: MIS TURNOS -->
  <div *ngIf="tabActivo === 'misturnos'">

    <div class="row">

      <!-- Pr√≥ximos Turnos -->
      <div class="col-lg-12 mb-4">
        <div class="content-card">
          <h5>Pr√≥ximos Turnos</h5>

          <div *ngIf="proximosTurnos.length === 0" class="alert alert-info">
            No tienes turnos pr√≥ximos. ¬°Agenda uno en la pesta√±a
            "Agendar Turno"!
          </div>

          <div *ngFor="let turno of proximosTurnos" class="turno-card">
            <div class="turno-header">
              <div class="turno-fecha">
                <div class="calendar-icon"
                  [style.background-color]="getCalendarIconColor(turno.estado)">
                  <div class="calendar-day">{{ getDiaMes(turno.fecha) }}</div>
                  <div class="calendar-month">{{ getMesCorto(turno.fecha)
                    }}</div>
                </div>
                <div class="turno-info">
                  <h6>{{ turno.motivo }}</h6>
                  <div class="turno-hora">üìç {{ formatearFecha(turno.fecha) }} -
                    {{ turno.hora }} a {{ turno.horaFin }} hs</div>
                  <div class="turno-descripcion">Asesor: {{ turno.asesor
                    }}</div>
                </div>
              </div>
              <div class="d-flex flex-column gap-2 align-items-end">
                <span class="badge"
                  [ngClass]="getEstadoBadgeClass(turno.estado)">
                  {{ getEstadoTexto(turno.estado) }}
                </span>
                <button class="btn btn-sm btn-outline-primary"
                  (click)="verDetallesTurno(turno)"
                  *ngIf="turno.estado !== 'pendiente'">
                  Ver Detalles
                </button>
                <button class="btn btn-sm btn-primary"
                  (click)="confirmarTurnoPendiente(turno)"
                  *ngIf="turno.estado === 'pendiente'">
                  Confirmar
                </button>
                <button class="btn btn-sm btn-outline-danger"
                  (click)="cancelarTurno(turno)">
                  Cancelar
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>

  </div>

  <!-- TAB: HISTORIAL -->
  <div *ngIf="tabActivo === 'historial'">

    <div class="content-card">
      <h5>Historial de Turnos</h5>

      <div *ngIf="historialTurnos.length === 0" class="alert alert-info">
        No tienes turnos en el historial a√∫n.
      </div>

      <div *ngFor="let turno of historialTurnos"
        class="turno-card"
        [style.border-left-color]="turno.estado === 'cancelado' ? '#dc3545' : '#6c757d'"
        [style.opacity]="0.8">
        <div class="turno-header">
          <div class="turno-fecha">
            <div class="calendar-icon"
              [style.background-color]="getCalendarIconColor(turno.estado)">
              <div class="calendar-day">{{ getDiaMes(turno.fecha) }}</div>
              <div class="calendar-month">{{ getMesCorto(turno.fecha) }}</div>
            </div>
            <div class="turno-info">
              <h6>{{ turno.motivo }}</h6>
              <div class="turno-hora">üìç {{ formatearFecha(turno.fecha) }} - {{
                turno.hora }} a {{ turno.horaFin }} hs</div>
              <div class="turno-descripcion">
                <span *ngIf="turno.estado === 'cancelado'">{{ turno.descripcion
                  }}</span>
                <span *ngIf="turno.estado !== 'cancelado'">Asesor: {{
                  turno.asesor }}</span>
              </div>
            </div>
          </div>
          <div>
            <span class="badge" [ngClass]="getEstadoBadgeClass(turno.estado)">
              {{ getEstadoTexto(turno.estado) }}
            </span>
          </div>
        </div>
      </div>

    </div>

  </div>

</div>

<!-- Modal Confirmar Turno -->
<div class="modal fade"
  [class.show]="mostrarModal"
  [style.display]="mostrarModal ? 'block' : 'none'"
  tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Turno</h5>
        <button type="button" class="btn-close"
          (click)="cerrarModal()"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3" *ngIf="turnoSeleccionado">
          Est√°s por confirmar el turno para el <strong>{{
            turnoSeleccionado.fechaTexto }}</strong>
          de <strong>{{ turnoSeleccionado.hora }}</strong> a <strong>{{
            turnoSeleccionado.horaFin }}</strong> hs.
        </p>
        <form>
          <div class="mb-3">
            <label for="motivo" class="form-label">Motivo de la Consulta</label>
            <select class="form-select"
              [(ngModel)]="motivoSeleccionado"
              name="motivo"
              required>
              <option value>Seleccione...</option>
              <option *ngFor="let motivo of motivosDisponibles"
                [value]="motivo.value">
                {{ motivo.label }}
              </option>
            </select>
          </div>
          <div class="mb-3">
            <label for="descripcion" class="form-label">Descripci√≥n
              (Opcional)</label>
            <textarea class="form-control"
              [(ngModel)]="descripcionTurno"
              name="descripcion"
              rows="3"
              placeholder="Breve descripci√≥n de tu consulta..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary"
          (click)="cerrarModal()">Cancelar</button>
        <button type="button" class="btn btn-primary"
          (click)="confirmarTurno()">Confirmar Turno</button>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop del modal -->
<div class="modal-backdrop fade"
  [class.show]="mostrarModal"
  *ngIf="mostrarModal"
  (click)="cerrarModal()"></div>

<!-- Footer -->
<footer class="bg-dark text-white py-4 mt-5">
  <div class="container">
    <div class="row">
      <div class="col-md-6">
        <h5>Estudio Jur√≠dico</h5>
        <p class="small">Soluciones legales profesionales desde 2003</p>
      </div>
      <div class="col-md-6 text-md-end">
        <p class="small mb-0">&copy; 2024 Estudio Jur√≠dico. Todos los derechos
          reservados.</p>
      </div>
    </div>
  </div>
</footer>
